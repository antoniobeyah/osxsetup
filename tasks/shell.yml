- name: Install Oh My ZSH
  shell: sh -c "$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"
  args:
    creates: "/Users/{{ lookup('env', 'USER') }}/.oh-my-zsh"
  tags: [ shell ]

- name: Delete existing plugins
  ansible.builtin.file:
    path: "/Users/{{ lookup('env', 'USER') }}/.oh-my-zsh/custom/plugins"
    state: "{{ item }}"
    mode: "0750"
  loop:
    - absent
    - directory
  tags: [ shell ]

- name: Clone zsh plugins
  ansible.builtin.shell: "git clone {{ item }}"
  args:
    chdir: "/Users/{{ lookup('env', 'USER') }}/.oh-my-zsh/custom/plugins"
  loop:
    - https://github.com/zsh-users/zsh-autosuggestions
    - https://github.com/zsh-users/zsh-syntax-highlighting.git
    - https://github.com/zsh-users/zsh-history-substring-search
    - https://github.com/MichaelAquilina/zsh-you-should-use.git
  ignore_errors: yes
  tags: [ shell ]

- name: Reconfigure zsh plugins
  ansible.builtin.lineinfile:
    path: "/Users/{{ lookup('env', 'USER') }}/.zshrc"
    regexp: "^plugins="
    line: "plugins=(git kubectl zsh-autosuggestions zsh-history-substring-search zsh-syntax-highlighting you-should-use)"
  tags: [ shell ]

- name: Add key bindings
  ansible.builtin.lineinfile:
    path: "/Users/{{ lookup('env', 'USER') }}/.zshrc"
    regexp: "^bindkey.*{{ item.key }}$"
    line: >
      bindkey "{{ item.value }}" {{ item.key }}
  vars:
    key_bindings:
      backward-word: "^[[D"
      forward-word: '^[[C'
      history-substring-search-up: "^[[A"
      history-substring-search-down: "^[[B"
  loop: "{{ key_bindings|dict2items }}"

  tags: [ shell ]

- name: Configure iTerm settings
  shell: >
    /usr/libexec/PlistBuddy  -c "Set :'New Bookmarks':0:'Unlimited Scrollback' 1" ~/Library/Preferences/com.googlecode.iterm2.plist
  tags: [ shell ]